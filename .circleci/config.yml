version: 2.1

jobs:
  build-and-publish:
    machine:
      image: ubuntu-2004:current
    steps:
      - checkout
      - run: |
          curl -L https://go.dev/dl/go1.23.0.linux-amd64.tar.gz | sudo tar -xzC /usr/local
          echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
          export PATH=$PATH:/usr/local/go/bin
      # Generated code is now committed, so we skip generation
      # - run: |
      #     export PATH=$PATH:/usr/local/go/bin
      #     go install github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen@latest
      #     export PATH=$PATH:$(go env GOPATH)/bin
      # - run: |
      #     # Download OpenAPI specification from somana repo
      #     mkdir -p api
      #     curl -L -o api/openapi.yaml https://github.com/miku-kookie/somana/releases/download/v1.0.30/openapi.yaml
      # - run: |
      #     export PATH=$PATH:/usr/local/go/bin:$(go env GOPATH)/bin
      #     # Generate code from OpenAPI spec
      #     mkdir -p internal/generated
      #     oapi-codegen -package generated -generate gin-server api/openapi.yaml > internal/generated/server.go
      #     oapi-codegen -package generated -generate types,client api/openapi.yaml > internal/generated/client.go
      - run: |
          # Install dependencies
          go mod download
          go get github.com/oapi-codegen/runtime
      - run: |
          # Install cross-compilation toolchains for CGO
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu gcc-x86-64-linux-gnu
      - run: |
          export PATH=$PATH:/usr/local/go/bin
          # Build for multiple architectures with CGO enabled and static linking
          mkdir -p bin
          # Linux AMD64 (statically linked)
          CGO_ENABLED=1 GOOS=linux GOARCH=amd64 CC=x86_64-linux-gnu-gcc go build -ldflags="-linkmode external -extldflags -static" -tags "osusergo netgo static_build" -o bin/sprinter-agent-linux-amd64 ./cmd/server
          # Linux ARM64 (statically linked)
          CGO_ENABLED=1 GOOS=linux GOARCH=arm64 CC=aarch64-linux-gnu-gcc go build -ldflags="-linkmode external -extldflags -static" -tags "osusergo netgo static_build" -o bin/sprinter-agent-linux-arm64 ./cmd/server
          # macOS AMD64 (CGO disabled for cross-compilation from Linux)
          CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -o bin/sprinter-agent-darwin-amd64 ./cmd/server
          # macOS ARM64 (CGO disabled for cross-compilation from Linux)
          CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -o bin/sprinter-agent-darwin-arm64 ./cmd/server
      - run: |
          # Install GitHub CLI
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y
      - run: |
          # Auto-increment version based on commit count
          COMMIT_COUNT=$(git rev-list --count HEAD)
          VERSION="v1.0.$COMMIT_COUNT"
          gh release create $VERSION \
            bin/sprinter-agent-linux-amd64 \
            bin/sprinter-agent-linux-arm64 \
            bin/sprinter-agent-darwin-amd64 \
            bin/sprinter-agent-darwin-arm64 \
            --title "Sprinter Agent $VERSION" \
            --notes "Sprinter Agent $VERSION - Built on CircleCI with multi-architecture support for Linux and macOS"

workflows:
  version: 2
  build-and-publish:
    jobs:
      - build-and-publish:
          filters:
            branches:
              only: main
